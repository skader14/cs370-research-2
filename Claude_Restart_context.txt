# CFR-RL Project - Complete Restart Context

**Last Updated:** December 2024  
**Status:** ROOT CAUSE FOUND AND FIXED - Ready for training

---

## PROJECT OVERVIEW

### Goal
Extend CFR-RL (Zhang et al., arXiv:2004.11986) to train with **real CloudSim latency feedback** instead of LP proxy metrics.

### Research Question
Can we train an RL policy that learns to select critical flows based on actual network congestion patterns observed in simulation?

### Architecture
```
Python Training Loop                    Java CloudSim
       │                                     │
       ├── Generate random workload ────────►│
       ├── Policy selects K=8 flows ────────►│
       │                                     ├── LP solver optimizes routing
       │                                     ├── Simulate network
       │◄── episode_summary.json ────────────┤
       │◄── flow_summary.csv ────────────────┤
       │◄── link_stats.csv ──────────────────┤
       ├── Compute reward                    │
       ├── REINFORCE policy update           │
       └── Next episode                      │
```

---

## ROOT CAUSE FOUND ✓

### The Problem
Generated workloads had ~66% packet drops while original Abilene workload had 0%.

### Scientific Investigation Results

| Test | Flow IDs | Timing/Sizes | Drop Rate | Conclusion |
|------|----------|--------------|-----------|------------|
| Original | Original | Original | 0% | Baseline |
| Test 1 | **Original** | Random | **3.9%** | ✓ Flow IDs matter! |
| Test 2 | **Generated** | Original | **66%** | ✗ Bad flow IDs |
| Exp 3 | Generated | ALL flows LP | 66% | LP can't help |

### Root Cause
**The randomly-selected flow IDs create bottlenecks in the Abilene topology.**

The original workload uses 51 specific flow IDs that distribute traffic well across the network. Random selection from all 132 possible flows picks combinations that all funnel through the same links, causing drops even when ALL flows get LP-optimized routing.

### The Fix
The workload generator now samples from `ABILENE_GOOD_FLOWS` - the 51 flow IDs from the original workload that are known to work:

```python
ABILENE_GOOD_FLOWS = [
    5, 7, 9, 10, 12, 13, 14, 15, 17, 18, 22, 23, 27, 30, 31, 33, 37, 39, 41, 
    47, 48, 49, 50, 52, 62, 72, 74, 77, 81, 83, 84, 85, 88, 89, 95, 96, 98, 
    102, 103, 106, 108, 109, 110, 113, 114, 115, 116, 122, 123, 130, 131
]
```

---

## WHAT ARE CRITICAL FLOWS?

In CFR-RL, the RL policy's job is to select **which flows to optimize**:

1. **132 possible flows** exist in the Abilene network (12 nodes × 11 destinations)
2. Policy selects **K=8 critical flows** per episode
3. **Only critical flows** get LP-optimized routing (smart path selection)
4. **Non-critical flows** use default shortest-path routing

**Why this matters:**
- If you select the RIGHT 8 flows (the ones causing bottlenecks), LP can route them better
- If you select the WRONG 8 flows, the actual bottleneck flows still congest the network
- With 50 active flows and only 8 optimized, 42 compete for shortest paths → potential congestion

---

## FILE STRUCTURE

### Essential Files
```
cloudsimsdn/
├── pom.xml                              # Maven build
├── src/                                 # Java source
│   └── org/cloudbus/cloudsim/sdn/
│       ├── example/
│       │   └── CFRRLTrainingRunner.java # Episode runner for training
│       ├── rl/
│       │   ├── LatencyCollector.java    # Per-packet latency tracking
│       │   └── LinkStatsCollector.java  # Per-link utilization tracking
│       └── policies/
│           └── CFRRLLinkPolicy.java     # LP-based routing policy
├── dataset-abilene/
│   ├── abilene-physical.json            # Network topology
│   ├── abilene-virtual.json             # VM placement
│   └── abilene-workload.csv             # Original benchmark (51 packets, 0% drops)
└── RL/
    ├── abilene_lp_solver_latency.py     # LP solver with latency weight
    ├── abilene_trainer_latency.py       # Original LP-based trainer
    └── csimtraining/                    # CloudSim-in-the-loop training
        ├── __init__.py
        ├── cloudsim_trainer.py          # Main training loop
        ├── policy_network.py            # Neural network + REINFORCE
        ├── feature_extractor.py         # 9 features per flow
        ├── workload_generator.py        # Random workload generation
        ├── episode_runner.py            # CloudSim subprocess wrapper
        ├── config.py                    # Hyperparameters
        ├── evaluate_policy.py           # Compare trained vs random
        └── test_training_setup.py       # Verification script
```

### Files to Clean Up
```
# Delete all of these:
test_*/                # Test directories
debug_*/               # Debug runs  
training_*/            # Training outputs
eval_*/                # Evaluation outputs
result_*/              # CloudSim auto-generated (empty)
outputs/               # Temporary outputs
*.log                  # Log files in root
```

---

## JAVA COMPONENTS

### CFRRLTrainingRunner.java
**Purpose:** Runs a single training episode from command line.

**Usage:**
```bash
mvn exec:java "-Dexec.mainClass=org.cloudbus.cloudsim.sdn.example.CFRRLTrainingRunner" \
  "-Dexec.args=<workload.csv> <critical_flows.txt> <output_dir>/"
```

**Inputs:**
- `workload.csv`: Traffic to simulate
- `critical_flows.txt`: One flow ID per line (e.g., "84\n50\n109...")

**Outputs:**
- `episode_summary.json`: Aggregate metrics (drop_rate, mean_queuing_ms, etc.)
- `flow_summary.csv`: Per-flow statistics
- `link_stats.csv`: Per-link utilization
- `latency_results.csv`: Per-packet latency breakdown

### LatencyCollector.java
**Purpose:** Tracks per-packet latency decomposition.

**Metrics:**
- Propagation delay (physical distance)
- Transmission delay (packet_size / bandwidth)
- Queuing delay (time waiting in buffers)
- Drop tracking

### LinkStatsCollector.java
**Purpose:** Tracks per-link utilization for features.

**Metrics:**
- Average utilization per link
- Max utilization per link
- Congestion events

### CFRRLLinkPolicy.java
**Purpose:** LP-based routing for critical flows.

**Behavior:**
- Critical flows → LP solver finds optimal paths
- Non-critical flows → Default shortest path

---

## PYTHON COMPONENTS

### Training Loop (cloudsim_trainer.py)
```python
for episode in range(500):
    # 1. Generate random workload
    workload = generate_workload(num_packets=50, duration=20)
    
    # 2. Extract features (9 per flow, using history from last episode)
    features = extractor.extract_features(demand_vector)
    
    # 3. Policy selects K=8 critical flows
    selected_flows, log_prob = policy.get_action(features, k=8)
    
    # 4. Run CloudSim subprocess
    results = runner.run_episode(workload, selected_flows, output_dir)
    
    # 5. Compute reward
    reward = -mean_queuing_ms/1000 - 10 * drop_rate
    
    # 6. REINFORCE update
    trainer.update(log_prob, reward)
    
    # 7. Update feature history for next episode
    extractor.update_history(results)
```

### 9 Features Per Flow
| # | Feature | Type | Description |
|---|---------|------|-------------|
| 1 | propagation_delay | Static | Physical latency from topology |
| 2 | path_length | Static | Number of hops |
| 3 | bottleneck_capacity | Static | Min link capacity on path |
| 4 | demand | Dynamic | Current episode traffic (bytes) |
| 5 | prev_mean_queuing | Historical | Flow's avg delay last episode |
| 6 | prev_max_queuing | Historical | Flow's max delay last episode |
| 7 | prev_drop_rate | Historical | Flow's drop rate last episode |
| 8 | prev_path_utilization | Historical | Avg link util on flow's path |
| 9 | prev_bottleneck_util | Historical | Max link util on flow's path |

### Reward Function
```python
reward = -mean_queuing_ms / 1000 - 10.0 * drop_rate
```
- Penalizes high queuing delay
- Heavily penalizes packet drops (10× weight)

---

## ORIGINAL ABILENE WORKLOAD CHARACTERISTICS

```
Packets: 51
Duration: 19.9 seconds
Total bytes: 6.39 GB
Average data rate: 2.57 Gbps
Packet sizes: 13 MB - 958 MB (avg 125 MB)
Packets per flow: 1 (each flow has exactly one packet)
Drop rate: 0%
Mean queuing: 12-14 ms
```

---

## COMMANDS REFERENCE

### Clean Up Repository
```powershell
Remove-Item -Recurse -Force test_*, debug_*, training_*, eval_*, result_*, outputs -ErrorAction SilentlyContinue
```

### Test Original Workload (should show 0% drops)
```powershell
mkdir outputs
echo "84`n50`n109`n17`n23`n91`n42`n7" | Set-Content test_critical.txt -Encoding ASCII
mvn exec:java "-Dexec.mainClass=org.cloudbus.cloudsim.sdn.example.CFRRLTrainingRunner" "-Dexec.args=dataset-abilene/abilene-workload.csv test_critical.txt outputs/verify/"
type outputs\verify\episode_summary.json
```

### Run Training (10 episodes)
```powershell
python RL/csimtraining/cloudsim_trainer.py --cloudsim-dir . --episodes 10 --packets 50 --duration 20 --output-dir training_test
```

### Run Debug Investigation
```powershell
python RL/csimtraining/debug_drop_rate.py
```

---

## KNOWN ISSUES & FIXES

### Issue 1: PowerShell file redirection creates UTF-16
**Symptom:** `java.lang.NumberFormatException: empty String`
**Fix:** Use `Copy-Item` or `-Encoding ASCII` instead of `>`

### Issue 2: Windows Maven command quoting
**Symptom:** Maven can't parse arguments
**Fix:** Use double quotes around `-D` flags: `"-Dexec.args=..."`

### Issue 3: CloudSim creates empty result_* directories
**Symptom:** Cluttered repository
**Fix:** Clean up with `Remove-Item -Recurse -Force result_*`

---

## INVESTIGATION STATUS

### Completed ✓
- [x] Java training runner implemented
- [x] Python training harness implemented
- [x] Training loop runs successfully
- [x] Original workload achieves 0% drops
- [x] Workload generator creates valid CSV format
- [x] Workload timestamps are correct (0-20 seconds)
- [x] **ROOT CAUSE IDENTIFIED: Flow ID selection matters**
- [x] **FIX IMPLEMENTED: Use ABILENE_GOOD_FLOWS**

### Ready to Execute
- [ ] Verify fix with short training run (10 episodes)
- [ ] Full training run (500 episodes)
- [ ] Evaluation against random baseline
- [ ] Final results and analysis

---

## NEXT STEPS

1. **Copy updated workload_generator.py** to RL/csimtraining/
2. **Verify fix with short training:**
   ```powershell
   python RL/csimtraining/cloudsim_trainer.py --cloudsim-dir . --episodes 10 --packets 50 --duration 20 --output-dir training_fixed
   ```
   Expected: Drop rates ~0-5% (not 66%)
   
3. **If successful, full training:**
   ```powershell
   python RL/csimtraining/cloudsim_trainer.py --cloudsim-dir . --episodes 500 --packets 50 --duration 20 --output-dir training_full
   ```

4. **Evaluate** trained policy vs random baseline

---

## PROMPT TO CONTINUE

Copy this to start a new conversation:

```
I'm working on CFR-RL with CloudSim-in-the-loop training. Upload CFRRL_RESTART_CONTEXT.md for full context.

STATUS: Root cause found and fixed!
- Problem: Random flow ID selection caused 66% drops
- Solution: Sample from ABILENE_GOOD_FLOWS (51 known-good flow IDs)
- Fix: Updated workload_generator.py

Ready to verify the fix and run training.

Files are in RL/csimtraining/. Test commands:
# Verify fix (should see low drop rates now)
python RL/csimtraining/cloudsim_trainer.py --cloudsim-dir . --episodes 10 --packets 50 --duration 20 --output-dir training_fixed

# Full training (after verification)
python RL/csimtraining/cloudsim_trainer.py --cloudsim-dir . --episodes 500 --packets 50 --duration 20 --output-dir training_full
```

---

## FILES TO UPLOAD FOR NEW CHAT

Minimum:
1. `CFRRL_RESTART_CONTEXT.md` (this file)

For deeper context:
2. `RL/csimtraining/workload_generator.py` (contains the fix)
3. `RL/csimtraining/cloudsim_trainer.py`
4. `dataset-abilene/abilene-workload.csv` (original benchmark)